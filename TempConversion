#include <iostream>
#include <iomanip>
#include <limits>
#include <cctype>

using namespace std;

bool readDouble(const char* prompt, double& out) 
{
    cout << prompt;
    if (cin >> out) return true;
    cin.clear();
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cerr << "Invalid number. Please try again.\n";
    return false;
}

char readUnit() 
{
    cout << "Enter unit (C for Celsius, F for Fahrenheit, K for Kelvin): ";
    char u;
    if (!(cin >> u)) 
    {
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        return '\0';
    }
    return static_cast<char>(toupper(static_cast<unsigned char>(u)));
}

void convertFromC(double C, double& F, double& K) 
{
    F = (C * 9.0 / 5.0) + 32.0;
    K = C + 273.15;
}

void convertFromF(double F, double& C, double& K) 
{
    C = (F - 32.0) * 5.0 / 9.0;
    K = C + 273.15;
}

bool convertFromK(double K, double& C, double& F) 
{
    if (K < 0.0) return false; // invalid physics
    C = K - 273.15;
    F = (C * 9.0 / 5.0) + 32.0;
    return true;
}

int main() {
    cout << fixed << setprecision(2);
    cout << "=== Temperature Converter (C <-> F <-> K) ===\n";

    while (true) {
        double inputTemp;
        while (!readDouble("Enter temperature value: ", inputTemp)) {
        }

        char unit = readUnit();
        if (unit != 'C' && unit != 'F' && unit != 'K') {
            cerr << "Invalid unit. Please enter C, F, or K\n";
            continue;
        }

        double C = 0.0, F = 0.0, K = 0.0;

        if (unit == 'C') {
            C = inputTemp;
            convertFromC(C, F, K);
        } else if (unit == 'F') {
            F = inputTemp;
            convertFromF(F, C, K);
        } else {
            K = inputTemp;
            if (!convertFromK(K, C, F)) {
                cerr << "Kelvin cannot be negative. Please try again.\n";
                continue;
            }
        }

        if (K < 0.0) {
            cerr << "Resulting Kelvin is negative, which is physically invalid. Check your input.\n";
            continue;
        }

        cout << "\nConverted Temperatures:\n";
        cout << "  Celsius    : " << C << " °C\n";
        cout << "  Fahrenheit : " << F << " °F\n";
        cout << "  Kelvin     : " << K << " K\n\n";

        cout << "Do you want to convert another? (Y/N): ";
        char again;
        if (!(cin >> again)) break;
        again = static_cast<char>(toupper(static_cast<unsigned char>(again)));
        if (again != 'Y') break;

        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        cout << "\n";
    }

    cout << "Goodbye!\n";
    cout << "Press Enter to exit...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();
    return 0;
}
